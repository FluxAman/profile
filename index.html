<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aman</title>

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link rel="stylesheet" href="Style.css">
</head>

<body>

    <div class="bg-blob"></div>

    <div class="container">

        <!-- LEFT PANEL: Profile Info -->
        <aside class="profile-section" id="profile-section">
            <!-- Content will be loaded here -->
        </aside>

        <!-- RIGHT PANEL: Content Feed -->
        <main class="content-section" id="content-section">

            <!-- Education Card -->
            <div class="card delay-1" id="education-card">
                <div class="section-title">
                    Education
                    <button class="edit-btn" onclick="editEducation()"><i class="fa-solid fa-pen"></i></button>
                </div>
                <div id="education-list">
                    <!-- Education items will be loaded here -->
                </div>
                <button class="add-btn" onclick="addEducationItem()" style="display:none;" id="add-edu-btn">+ Add
                    Education</button>
            </div>

            <!-- Posts will be loaded here -->
            <div id="posts-container"></div>

            <button class="add-btn" onclick="addNewPost()">+ New Post</button>

        </main>

    </div>

    <script>
        let currentData = {};

        // Load data on start
        async function loadData() {
            try {
                const res = await fetch('/api/data');
                currentData = await res.json();
                renderProfile();
                renderEducation();
                renderPosts();
            } catch (e) {
                console.error('Failed to load data', e);
            }
        }

        function renderProfile() {
            const p = currentData.profile;
            const html = `
                <div id="profile-display">
                    <img src="${p.photo}" alt="Profile" class="profile-pic">
                    <h1 class="name">${p.name}</h1>
                    <p class="role">${p.role}</p>
                    
                    <div class="location">
                        <i class="fa-solid fa-location-dot"></i> ${p.location}
                    </div>

                    <div class="social-links">
                        <a href="https://github.com/FluxAman" class="social-btn"><i class="fa-brands fa-github"></i></a>
                        <a href="https://www.linkedin.com/in/FluxAman" class="social-btn"><i class="fa-brands fa-linkedin-in"></i></a>
                        <a href="https://youtube.com/@amanraoo?si=ZMXvrQxN1KgPMGWL" class="social-btn"><i class="fa-brands fa-brands fa-youtube"></i></a>
                        <button class="social-btn" onclick="editProfile()"><i class="fa-solid fa-pen"></i></button>
                    </div>
                </div>
                <div id="profile-edit" style="display:none;">
                    <input type="text" id="edit-name" class="edit-mode" value="${p.name}" placeholder="Name">
                    <input type="text" id="edit-role" class="edit-mode" value="${p.role}" placeholder="Role">
                    <input type="text" id="edit-location" class="edit-mode" value="${p.location}" placeholder="Location">
                    <div class="edit-actions">
                        <button class="save-btn" onclick="saveProfile()">Save</button>
                        <button class="cancel-btn" onclick="cancelProfileEdit()">Cancel</button>
                    </div>
                </div>
            `;
            document.getElementById('profile-section').innerHTML = html;
        }

        function editProfile() {
            document.getElementById('profile-display').style.display = 'none';
            document.getElementById('profile-edit').style.display = 'block';
        }

        function cancelProfileEdit() {
            document.getElementById('profile-display').style.display = 'block';
            document.getElementById('profile-edit').style.display = 'none';
        }

        async function saveProfile() {
            currentData.profile.name = document.getElementById('edit-name').value;
            currentData.profile.role = document.getElementById('edit-role').value;
            currentData.profile.location = document.getElementById('edit-location').value;

            await saveData();
            renderProfile();
        }

        function renderEducation() {
            const list = document.getElementById('education-list');
            list.innerHTML = currentData.education.map((edu, index) => `
                <div class="edu-item" style="${index > 0 ? 'margin-top:15px' : ''}">
                    <div class="degree">${edu.degree}</div>
                    <div class="school">${edu.school}</div>
                </div>
            `).join('');
        }

        function editEducation() {
            const list = document.getElementById('education-list');
            list.innerHTML = currentData.education.map((edu, index) => `
                <div class="edu-item-edit" style="margin-bottom: 15px; border-left: 3px solid #ced2d3; padding-left: 15px;">
                    <input type="text" class="edit-mode edu-degree-input" value="${edu.degree}" placeholder="Degree">
                    <input type="text" class="edit-mode edu-school-input" value="${edu.school}" placeholder="School/Year">
                    <button class="cancel-btn" onclick="deleteEducation(${index})" style="font-size:0.7rem; padding: 2px 5px;">Delete</button>
                </div>
            `).join('') + `
                <div class="edit-actions">
                    <button class="save-btn" onclick="saveEducation()">Save</button>
                    <button class="cancel-btn" onclick="renderEducation(); document.getElementById('add-edu-btn').style.display='none';">Cancel</button>
                </div>
            `;
            document.getElementById('add-edu-btn').style.display = 'block';
        }

        function addEducationItem() {
            currentData.education.push({ degree: "New Degree", school: "School â€¢ Year" });
            editEducation(); // Re-render in edit mode
        }

        function deleteEducation(index) {
            currentData.education.splice(index, 1);
            editEducation();
        }

        async function saveEducation() {
            const degrees = document.querySelectorAll('.edu-degree-input');
            const schools = document.querySelectorAll('.edu-school-input');

            currentData.education = Array.from(degrees).map((input, i) => ({
                degree: input.value,
                school: schools[i].value
            }));

            await saveData();
            renderEducation();
            document.getElementById('add-edu-btn').style.display = 'none';
        }

        function renderPosts() {
            const container = document.getElementById('posts-container');
            container.innerHTML = currentData.posts.map((post, index) => `
                <div class="card delay-${index + 2}">
                    <div class="post-header">
                        <img src="${currentData.profile.photo}" class="mini-dp" alt="dp">
                        <div class="post-meta">
                            <h3>${post.author}</h3>
                            <span>${post.time}</span>
                        </div>
                        <button class="edit-btn" style="margin-left:auto" onclick="editPost(${index})"><i class="fa-solid fa-pen"></i></button>
                    </div>
                    <div class="post-text" style="white-space: pre-wrap;">${post.text}</div>
                    ${post.media ? (post.media.type === 'video' ?
                    `<video src="${post.media.src}" class="video" controls></video>` :
                    `<img src="${post.media.src}" class="post-image">`)
                    : ''}
                </div>
            `).join('');
        }

        function editPost(index) {
            const post = currentData.posts[index];
            const container = document.getElementById('posts-container');
            const cards = container.getElementsByClassName('card');
            const card = cards[index];

            card.innerHTML = `
                <div class="post-header">
                    <img src="${currentData.profile.photo}" class="mini-dp" alt="dp">
                    <div class="post-meta">
                        <h3>${post.author}</h3>
                        <span>${post.time}</span>
                    </div>
                </div>
                <textarea class="edit-mode" id="edit-post-text-${index}" rows="5">${post.text}</textarea>
                
                <div style="margin-top: 10px;">
                    <label style="display:block; margin-bottom:5px; color:#aaa; font-size:0.9rem;">Update Media (Image/Video):</label>
                    <input type="file" id="edit-post-file-${index}" class="edit-mode" accept="image/*,video/*">
                </div>

                <div class="edit-actions">
                    <button class="save-btn" onclick="savePost(${index})">Save</button>
                    <button class="cancel-btn" onclick="renderPosts()">Cancel</button>
                    <button class="cancel-btn" onclick="deletePost(${index})" style="float:right">Delete Post</button>
                </div>
            `;
        }

        function addNewPost() {
            const newPost = {
                id: Date.now(),
                author: currentData.profile.name,
                time: "Just now",
                text: "New post...",
                media: null
            };
            currentData.posts.unshift(newPost);
            renderPosts();
            editPost(0); // Immediately enter edit mode
        }

        function deletePost(index) {
            if (confirm('Are you sure you want to delete this post?')) {
                currentData.posts.splice(index, 1);
                saveData();
                renderPosts();
            }
        }

        async function savePost(index) {
            const text = document.getElementById(`edit-post-text-${index}`).value;
            const fileInput = document.getElementById(`edit-post-file-${index}`);

            // Handle file upload if a file is selected
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                const formData = new FormData();
                formData.append('file', file);

                try {
                    const res = await fetch('/api/upload', {
                        method: 'POST',
                        body: formData
                    });
                    const data = await res.json();

                    if (data.url) {
                        currentData.posts[index].media = {
                            type: data.type.startsWith('video') ? 'video' : 'image',
                            src: data.url
                        };
                    }
                } catch (e) {
                    console.error('Upload failed', e);
                    alert('Failed to upload file');
                    return;
                }
            }

            currentData.posts[index].text = text;
            await saveData();
            renderPosts();
        }

        async function saveData() {
            try {
                await fetch('/api/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(currentData)
                });
            } catch (e) {
                console.error('Failed to save', e);
                alert('Failed to save changes');
            }
        }

        // Init
        loadData();
    </script>
</body>

</html>